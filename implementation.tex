%!TEX root =  index.tex

\section{Implementation}

In this chapter, we are describing the implementation. All of the code can be found at \cite{Zeyer13Github}.

\subsection{$\curlO$ and $\curlO^\#$ representation and calculations}

To represent $\curlO$ and $\curlO^\#$ in code, mostly in the low level C++ code (files \ifilename{algo_cpp.cpp}, \ifilename{structs.hpp}, \ifilename{reduceGL.hpp}), we can use two integers in both cases as the coefficients of some basis.

\subsubsection{Representations}

%\paragraph{$\curlO$.}
\label{impl:repr:curlO}

For $a \in \curlO$, we use
\[ a = a_1 + a_2 \frac{D + \sqrt{D}} {2} \]
with $a_1,a_2 \in \Z$.
It holds
\begin{align*}
\Re(a) = &\; a_1 + a_2 \frac{D}{2} , \\
\Re(a)^2 =&\; a_1^2 + D a_1 a_2 + \frac{D^2}{4} a_2^2 , \\
\Im(a) =&\; a_2 \frac{\sqrt{-D}}{2} , \\
\Im(a)^2 =&\; a_2^2 \frac{-D}{4} , \\
|a|^2 =&\; \Re(a)^2 + \Im(a)^2 = a_1^2 - (-D) a_1 a_2 + \frac{D^2-D}{4} a_2^2 .
\end{align*}
Note that $4$ divides $D^2 - D$. Thus, $|a|^2 \in \Z$.

%4.5.13. b\in\curlO
Sometimes we have given $a \in \K$ where we easily have $\Re(a)$ and $\Im(a)$ available and we want to calculate $a_1, a_2 \in \Q$ in the above representation. We get
\begin{align*}
a_2 = &\; \Im(a) \frac{2}{\sqrt{-D}}, \\
a_1 = &\; \Re(a) - a_2 \frac{D}{2} = \Re(a) + \Im(a) \sqrt{-D} .
\end{align*}

%\paragraph{$\curlO^\#$.}
\label{impl:repr:curlOdual}

For $b \in \curlO^\#$, we use
\[ b = b_1 \frac{1}{\sqrt{D}} + b_2 \frac{1 + \sqrt{D}} {2} \]
with $b_1,b_2 \in \Z$.
% 6.6. alt det \cO^#
It holds
\begin{align*}
\Re(b) = &\; \frac{1}{2} b_2, \\
\Re(b)^2 = &\; \frac{1}{4} b_2^2, \\
\Im(b) = &\; -\frac{b_1}{\sqrt{-D}} + \frac{1}{2} \sqrt{-D} b_2, \\
\Im(b)^2 = &\; \frac{b_1^2}{-D} - b_1 b_2 + \frac{1}{4} (-D) b_2^2, \\
|b|^2 = &\; \Re(b)^2 + \Im(b)^2 = \frac{b_1^2}{-D} - b_1 b_2 + \frac{1}{4} (1-D) b_2^2 .
\end{align*}
When we need $|b|^2$ in an implementation, we can multiply it with $-D$ to get an integer:
\[ (-D) |b|^2 = b_1^2 - (-D) b_1 b_2 + \frac{D^2-D}{4} b_2^2 . \]
%
%4.5.13 b \in \curlO^#
%5.6.13 a \in \curlO^#
When we have $b \in \K$ where $\Re(b)$ and $\Im(b)$ are easily available and when we want to calculate $b_1,b_2 \in \Q$ in the above representation, we get
\begin{align*}
b_2 =&\; 2 \Re(b) , \\
b_1 =&\; b_2 \frac{-D}{2} - \Im(b) \sqrt{-D} = \Re(b) (-D) - \Im(b) \sqrt{-D} .
\end{align*}

%3.5.13 \curlO^# conjugate
Let us calculate the complex conjugate $\overline{b}$ of $b \in \curlO^\#$:
\begin{align*}
\overline{b} &= \frac{-b_1}{\sqrt{D}} + \frac{b_2}{2} - b_2 \frac{\sqrt{D}}{2} \\
&\overset{!}{=} \hat{b}_1 \frac{1}{\sqrt{D}} + \hat{b}_2 \frac{1 + \sqrt{D}} {2} \\
\Rightarrow \quad \hat{b}_2 &= b_2 , \\
\hat{b}_1 &= \overline{b} \sqrt{D} - \hat{b}_2 (\sqrt{D}+D) \tfrac{1}{2} \\
&= b_2 \frac{\sqrt{D}}{2} - b_2 \frac{\sqrt{D}}{2} - b_2 \frac{D}{2} - b_2 \frac{D}{2} - b_1 \\
&= -b_2 D - b_1 .
\end{align*}

%3.5.13 \curlO^# conjugate
Note that $b \in \R$ if and only if $b_1 \frac{1}{\sqrt{D}} = - b_2 \frac{\sqrt{D}}{2}$, i.e.
\[ 2 b_1 = - b_2 D . \]

\subsubsection{Multiplications}
%3.5. ElemOfCurlO.mul()
Let $a,b \in \curlO$ with $a = a_1 + a_2 \frac{D + \sqrt{D}} {2}$, $b = b_1 + b_2 \frac{D + \sqrt{D}} {2}$. Then we have
\begin{align*}
a \cdot b &= a_1 b_1 + a_1 b_2 (D + \sqrt{D}) \tfrac{1}{2} + b_1 a_2 (D + \sqrt{D}) \tfrac{1}{2}
+ a_2 b_2 \tfrac{1}{4} \underbrace{(D^2 + 2 D \sqrt{D} + D)}_{= 2D (D + \sqrt{D}) - D^2 + D} \\
&= \frac{\sqrt{D} + D}{2} (a_1 b_2 + b_1 a_2 + D a_2 b_2)
+ a_1 b_1 - a_2 b_2 \frac{D^2 - D}{4} .
\end{align*}

%3.5.13 mult \curlO^# und \curlO
Now, let $a \in \curlO^\#$ and $b \in \curlO$ with
\begin{align*}
a &= a_1 \frac{1}{\sqrt{D}} + a_2 \frac{1 + \sqrt{D}} {2} , \\
b &= b_1 + b_2 \frac{D + \sqrt{D}} {2} .
\end{align*}
Then we have
\begin{align*}
a \cdot b &= a_1 b_1 \tfrac{1}{\sqrt{D}} + a_1 b_2 (\sqrt{D} + 1) \tfrac{1}{2}
+ a_2 b_1 (1 + \sqrt{D}) \tfrac{1}{2} + a_2 b_2
\underbrace{(D + \sqrt{D} + D \sqrt{D} + D)}_{
\begin{aligned}
= 2D + \sqrt{D} + D \sqrt{D} \\
= 2D + \sqrt{D} (1 + D)
\end{aligned}
}
\tfrac{1}{4} \\
&= a_1 b_1 \tfrac{1}{\sqrt{D}} + (a_1 b_2 + a_2 b_1) (1 + \sqrt{D}) \tfrac{1}{2}
+ a_2 b_2 (2D + \sqrt{D}(1 + D)) \tfrac{1}{4} .
\end{align*}
Thus, when representing $a \cdot b \in \curlO^\#$ as
\[ a \cdot b = (ab)_1 \frac{1}{\sqrt{D}} + (ab)_2 \frac{1 + \sqrt{D}} {2} , \]
we get
\[ (ab)_2 = a_1 b_2 + a_2 b_1 + a_2 b_2 D \]
and
\begin{align*}
(ab)_1 &= \sqrt{D} ab - (ab)_2 (\sqrt{D} + D) \tfrac{1}{2} \\
&= a_1 b_1 + (a_1 b_2 + b_1 a_2) (\sqrt{D} + D) \tfrac{1}{2} + a_2 b_2 (D + \sqrt{D})^2 \tfrac{1}{4} \\
&\quad - (a_1 b_2 + a_2 b_1 + a_2 b_2 D) (\sqrt{D} + D) \tfrac{1}{2} \\
&= a_1 b_1 + a_2 b_2 \underbrace{( (D+\sqrt{D})^2 \tfrac{1}{4} - D(\sqrt{D}+D)\tfrac{1}{2} )}_{
\begin{aligned}[l]
=& \tfrac{D^2}{4} + \tfrac{D\sqrt{D}}{2} + \tfrac{D}{4} - \tfrac{D\sqrt{D}}{2} - \tfrac{D^2}{2} \\
=& \tfrac{D^2 - D}{4}
\end{aligned}
} \\
&= a_1 b_1 + a_2 b_2 \frac{D^2 - D}{4} .
\end{align*}

\subsubsection{Determinant of 2-by-2 matrices}

%16.4.13 det(S)
For $[a,b,c] \in \Her_2(\C)$, we have
\[ \det([a,b,c]) = ac - b \overline{b} = ac - |b|^2 . \]
%
When we have $b \in \curlO$ or $b \in \curlO^\#$, we have given a formula for $|b|^2$ in \cref{impl:repr:curlO}.

\subsubsection{Trace of $TS$}
%16.4.13 tr(ST)
We want to calculate $\tr(TS)$ for $T \in \Her_2(\curlO^\#)$, $S \in \Her_2(\curlO)$.
Let $T = [T_a, T_b, T_c]$ and $S = [S_a, S_b, S_c]$ with
\begin{align*}
T_b &= T_{b1} \frac{1}{\sqrt{D}} + T_{b2} \frac{1 + \sqrt{D}} {2} , \\
S_b &= S_{b1} + S_{b2} \frac{D + \sqrt{D}} {2}
\end{align*}
and we have
\[ \overline{S_b} = S_{b1} + S_{b2} \frac{D - \sqrt{D}} {2} . \]
Then,
\[
\tr(T S) = T_a S_a
+ \underbrace{T_b \overline{S_b} + \overline{T_b} S_b}_{= 2 \Re(T_b \overline{S_b})}
+ T_c S_c
\]
and
\begin{align*}
\overline{S_b} T_b &= S_{b1} T_{b1} \tfrac{1}{\sqrt{D}} + S_{b1} T_{b2} (1 + \sqrt{D}) \tfrac{1}{2}
+ S_{b2} D \tfrac{1}{2} T_{b1} \tfrac{1}{\sqrt{D}}
- S_{b2} \tfrac{1}{2} T_{b1} \\
&\quad + T_{b2} S_{b2} \tfrac{1}{4} \underbrace{(D - \sqrt{D} + D \sqrt{D} - D)}_{=\sqrt{D}(D-1)} \\
\Rightarrow \Re(\overline{S_b} T_b) &= S_{b1} T_{b2} \tfrac{1}{2} - S_{b2} T_{b1} \tfrac{1}{2} .
\end{align*}
Thus, in our Computer implementation, we can just use
\[ \tr(T S) = T_a S_a + T_c S_c + S_{b1} T_{b2} - S_{b2} T_{b1} . \]
And if we have $T_a, T_{b1}, T_{b2}, T_{c}, S_a, S_{b1}, S_{b2}, S_c \in \Z$, we also have $\tr(TS) \in \Z$.


\subsection{Iteration of the precision Fourier indice $\F$}

The set $\F$ depends on a limit $B_\F \in \N$:
\[ \F = \F_B = \Set{\SimpleMatrix{a}{b}{\overline b}{c} \in \Lambda}{0 \le a , c < B_{\F}} \subseteq \Lambda . \]
In \cref{remark:reducedCurlF}, we see that $\F$ is finite.

We have implemented an iteration of $\F$ in a way that the list of $\F_{B_2}$ always starts with $\F_{B_1}$ if $B_1 \le B_2$. That is \ifuncname{PrecisionF} in \ifilename{algo_cpp.cpp} and \ifuncname{curlF_iter_py} in \ifilename{helpers.py}. I.e., in Python, that is
\begin{lstlisting}
Foo = list
\end{lstlisting}

\subsection{Iteration of $S \in \PM_2(\curlO)$}

The matrices $S \in \PM_2(\curlO)$ are used for the reduction in $f[S]$ for an Hermitian modula form $f$.

There are multiple implementations of this iteration.

\subsection{\ifuncname{reduceGL}}
\label{impl:reduceGL}
In \cref{remark:reducedCurlF}, we have described that it is sufficient to use reduced matrices $\hat{T} \in \F$. Thus, in our implementation, for a given matrix $T \in \F$, we need a way to calculate the reduced matrix $\hat{T} \in \F$ such that
\[ \hat{T}[U_T] = T \]
for some $U_T \in \GL_2(\curlO)$. In the code, we don't need $U_T$ directly but rather the determinant of $U_T$.

Dominic Gehre and Martin Raum have developed a Cython implementation \cite{Raum09reduceGL} of "Functions for reduction of fourier indice of Hermitian modular forms". This function \ifuncname{reduceGL} gets a matrix $T \in \Her_2(\curlO^\#)$ and returns the reduced matrix $\hat{T} \in \Her_2(\curlO^\#)$ and some character evaluation of $U_T$ which also declares the determinant of $U_T$.

In this work, this function \ifuncname{reduceGL} has been reimplemented in C++ (\ifilename{reduceGL.hpp}) and in Python (\ifilename{reduceGL.py}).


\subsection{\ifuncname{divmod} and \ifuncname{xgcd}}

\subsection{\ifuncname{solveR}}

\subsection{Calculating the matrix of the map $a \rightarrow a[S]$}
\label{impl:calcMatrix}

\subsection{Parallelization}
