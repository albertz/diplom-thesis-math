%!TEX root =  index.tex

\section{Implementation}

In this chapter, we are describing the implementation.

\subsection{$\curlO$ and $\curlO^\#$ representation and calculation}

To represent $\curlO$ and $\curlO^\#$ in code, mostly in the low level C++ code, we can use two integers in both cases as the coefficients of some basis.

\subsubsection{Representations}

\paragraph{$\curlO$.}

For $a \in \curlO$, we use
\[ a = a_1 + a_2 \frac{D + \sqrt{D}} {2} \]
with $a_1,a_2 \in \Z$.
It holds
\begin{align*}
\Re(a) = &\; a_1 + a_2 \frac{D}{2} , \\
\Re(a)^2 =&\; a_1^2 + D a_1 a_2 + \frac{D^2}{4} a_2^2 , \\
\Im(a) =&\; a_2 \frac{\sqrt{-D}}{2} , \\
\Im(a)^2 =&\; a_2^2 \frac{-D}{4} , \\
|a|^2 =&\; \Re(a)^2 + \Im(a)^2 = a_1^2 - (-D) a_1 a_2 + \frac{D^2-D}{4} a_2^2 .
\end{align*}
Note that $4$ divides $D^2 - D$. Thus, $|a|^2 \in \Z$.

%4.5.13. b\in\curlO
Sometimes we have given $a \in \K$ where we easily have $\Re(a)$ and $\Im(a)$ available and we want to calculate $a_1, a_2 \in \Q$ in the above representation. We get
\begin{align*}
a_2 = &\; \Im(a) \frac{2}{\sqrt{-D}}, \\
a_1 = &\; \Re(a) - a_2 \frac{D}{2} = \Re(a) + \Im(a) \sqrt{-D} .
\end{align*}

\paragraph{$\curlO^\#$.}

For $b \in \curlO^\#$, we use
\[ b = b_1 \frac{1}{\sqrt{D}} + b_2 \frac{1 + \sqrt{D}} {2} \]
with $b_1,b_2 \in \Z$.
% 6.6. alt det \cO^#
It holds
\begin{align*}
\Re(b) = &\; \frac{1}{2} b_2, \\
\Re(b)^2 = &\; \frac{1}{4} b_2^2, \\
\Im(b) = &\; -\frac{b_1}{\sqrt{-D}} + \frac{1}{2} \sqrt{-D} b_2, \\
\Im(b)^2 = &\; \frac{b_1^2}{-D} - b_1 b_2 + \frac{1}{4} (-D) b_2^2, \\
|b|^2 = &\; \Re(b)^2 + \Im(b)^2 = \frac{b_1^2}{-D} - b_1 b_2 + \frac{1}{4} (1-D) b_2^2 .
\end{align*}
When we need $|b|^2$ in an implementation, we can multiply it with $-D$ to get an integer:
\[ (-D) |b|^2 = b_1^2 - (-D) b_1 b_2 + \frac{D^2-D}{4} b_2^2 . \]
%
%4.5.13 b \in \curlO^#
%5.6.13 a \in \curlO^#
When we have $b \in \K$ where $\Re(b)$ and $\Im(b)$ are easily available and when we want to calculate $b_1,b_2 \in \Q$ in the above representation, we get
\begin{align*}
b_2 =&\; 2 \Re(b) , \\
b_1 =&\; b_2 \frac{-D}{2} - \Im(b) \sqrt{-D} = \Re(b) (-D) - \Im(b) \sqrt{-D} .
\end{align*}

%3.5.13 \curlO^# conjugate
Let us calculate the complex conjugate $\overline{b}$ of $b \in \curlO^\#$:
\begin{align*}
\overline{b} &= \frac{-b_1}{\sqrt{D}} + \frac{b_2}{2} - b_2 \frac{\sqrt{D}}{2} \\
&\overset{!}{=} \hat{b}_1 \frac{1}{\sqrt{D}} + \hat{b}_2 \frac{1 + \sqrt{D}} {2} \\
\Rightarrow \quad \hat{b}_2 &= b_2 , \\
\hat{b}_1 &= \overline{b} \sqrt{D} - \hat{b}_2 (\sqrt{D}+D) \tfrac{1}{2} \\
&= b_2 \frac{\sqrt{D}}{2} - b_2 \frac{\sqrt{D}}{2} - b_2 \frac{D}{2} - b_2 \frac{D}{2} - b_1 \\
&= -b_2 D - b_1 .
\end{align*}

%3.5.13 \curlO^# conjugate
Note that $b \in \R$ if and only if $b_1 \frac{1}{\sqrt{D}} = - b_2 \frac{\sqrt{D}}{2}$, i.e.
\[ 2 b_1 = - b_2 D . \]

\subsubsection{Multiplications}

\subsubsection{Determinant of 2-by-2 matrices}

For $[a,b,c] \in \Her_2(\curlO)$, we have

\subsubsection{$\tr(TS)$ for $T \in \Her_2(\curlO)$, $S \in \Her_2(\curlO^\#)$}


\subsection{$reduceGL$}
\label{impl:reduceGL}

\subsection{$divmod$ and $xgcd$}

\subsection{Calculating the matrix of the map $a \rightarrow a[S]$}
\label{impl:calcMatrix}

\subsection{Parallelization}
